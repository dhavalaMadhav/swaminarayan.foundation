<%- include('../partials/head') %>

<body class="admin-body">
  <div class="admin-container">
    <aside class="admin-sidebar">
      <div class="admin-logo">
        <h2>SU Admin</h2>
      </div>
      
      <nav class="admin-nav">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/applications" class="active">Applications</a>
        <a href="#" onclick="logout()">Logout</a>
      </nav>
    </aside>
    
    <main class="admin-main">
      <header class="admin-header">
        <h1>Application Details</h1>
        <div class="admin-user">
          <%= admin.name || 'Administrator' %>
        </div>
      </header>
      
      <div class="admin-content">
        <div class="back-link">
          <a href="/admin/applications">← Back to Applications</a>
        </div>
        
        <div id="applicationDetail" class="application-detail">
          <p>Loading...</p>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    const token = localStorage.getItem('token');
    const applicationId = '<%= applicationId %>';
    
    if (!token) {
      window.location.href = '/admin/login';
    }
    
    fetch(`/admin/api/applications/${applicationId}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const app = data.application;
        
        document.getElementById('applicationDetail').innerHTML = `
          <div class="detail-section">
            <h2>Personal Information</h2>
            <div class="detail-grid">
              <div class="detail-item">
                <strong>Application ID:</strong> ${app.applicationId}
              </div>
              <div class="detail-item">
                <strong>Full Name:</strong> ${app.fullName}
              </div>
              <div class="detail-item">
                <strong>Email:</strong> ${app.email}
              </div>
              <div class="detail-item">
                <strong>Phone:</strong> ${app.phone}
              </div>
              <div class="detail-item">
                <strong>Date of Birth:</strong> ${new Date(app.dateOfBirth).toLocaleDateString()}
              </div>
              <div class="detail-item">
                <strong>Address:</strong> ${app.address}
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h2>Academic Information</h2>
            <div class="detail-grid">
              <div class="detail-item">
                <strong>Qualification:</strong> ${app.qualification}
              </div>
              <div class="detail-item">
                <strong>Board/University:</strong> ${app.boardUniversity}
              </div>
              <div class="detail-item">
                <strong>Year of Passing:</strong> ${app.yearOfPassing}
              </div>
              <div class="detail-item">
                <strong>Percentage:</strong> ${app.percentage}%
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h2>Program Details</h2>
            <div class="detail-grid">
              <div class="detail-item">
                <strong>Program Type:</strong> ${app.programType}
              </div>
              <div class="detail-item">
                <strong>Course Name:</strong> ${app.courseName}
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h2>Documents</h2>
            <div class="document-links">
              <a href="/uploads/${app.documents.photo}" target="_blank" class="btn btn-secondary">View Photo</a>
              <a href="/uploads/${app.documents.idProof}" target="_blank" class="btn btn-secondary">View ID Proof</a>
              <a href="/uploads/${app.documents.academicCertificate}" target="_blank" class="btn btn-secondary">View Certificate</a>
            </div>
          </div>
          
          <div class="detail-section">
            <h2>Payment Information</h2>
            <div class="detail-grid">
              <div class="detail-item">
                <strong>Payment Status:</strong> 
                <span class="badge badge-${app.paymentStatus}">${app.paymentStatus}</span>
              </div>
              ${app.paymentId ? `
                <div class="detail-item">
                  <strong>Payment ID:</strong> ${app.paymentId.razorpayPaymentId || 'N/A'}
                </div>
                <div class="detail-item">
                  <strong>Amount:</strong> ₹${app.paymentId.amount}
                </div>
                <div class="detail-item">
                  <strong>Paid At:</strong> ${app.paymentId.paidAt ? new Date(app.paymentId.paidAt).toLocaleString() : 'N/A'}
                </div>
              ` : ''}
            </div>
          </div>
          
          <div class="detail-section">
            <h2>Application Status</h2>
            <select id="applicationStatus" class="form-control" onchange="updateStatus()">
              <option value="submitted" ${app.applicationStatus === 'submitted' ? 'selected' : ''}>Submitted</option>
              <option value="under_review" ${app.applicationStatus === 'under_review' ? 'selected' : ''}>Under Review</option>
              <option value="approved" ${app.applicationStatus === 'approved' ? 'selected' : ''}>Approved</option>
              <option value="rejected" ${app.applicationStatus === 'rejected' ? 'selected' : ''}>Rejected</option>
            </select>
          </div>
        `;
      }
    })
    .catch(err => {
      console.error('Error loading application:', err);
    });
    
    function updateStatus() {
      const status = document.getElementById('applicationStatus').value;
      
      fetch(`/admin/api/applications/${applicationId}/status`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ applicationStatus: status })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Status updated successfully');
        } else {
          alert('Error updating status');
        }
      });
    }
    
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/admin/login';
    }
  </script>
</body>
</html>
